<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Tic-tac-toe</title>

<style>
	canvas{
		
		position:absolute;
		margin:auto;
		top:0;
		bottom:0;
		left:0;
		right:0;
		}
</style>


<script>
var canvas, cntx;
var data;
var player; 


window.onload = function main() {
	canvas = document.createElement("canvas");
	canvas.width = canvas.height = 3*120 + 20;
	cntx = canvas.getContext("2d");
	
	document.body.appendChild(canvas);
	
	canvas.addEventListener("mousedown", mouseDown);

	init();
	tick();
}

function init() {

	if (data == null) {
		data = [];

		for (var i = 0; i < 9; i++) {
			var x = (i % 3)*120 + 20;
			var y = Math.floor(i/3)*120 + 20;
			data.push(new Tile(x, y));
		}
	}
	player = Tile.NOUGHT; //intialize nought player
	//data = new Tile(20,20);
	//data[0].flip(Tile.NOUGHT);
}

function tick() {
	window.requestAnimationFrame(tick);
	
	update();
	render();
}

function update() {
	//data.update();
	for (var i = data.length; i--;) {
	data[i].update();
	}
}

function render() {
	cntx.clearRect(0,0, canvas.width, canvas.height);

	//data.draw(cntx);
	for (var i = data.length; i--;) {
	data[i].draw(cntx);
	}
}

function mouseDown(evt) {
	var el = evt.target;

	var px = evt.clientX - el.offsetLeft;
	var py = evt.clientY - el.offsetTop;

	if(px % 120 >= 20 && py % 120 >= 20){ //add click area
		var idx = Math.floor(px/120);
		idx += Math.floor(py/120)*3;

		if(data[idx].hasData()){
			return;
		}
		data[idx].flip(player);
		player = player === Tile.NOUGHT ? Tile.CROSS : Tile.NOUGHT; //CROSS and NOUGHT player run after each other run.
	}
}


function Tile(x, y) {
	var x = x, y = y;
	
	var tile = Tile.BLANK;
	var anim = 0;
	
	if(tile == null) {
		
		var _c = document.createElement("canvas");
		_c.width = _c.height = 100;
		_cntx = _c.getContext("2d");
		
		_cntx.fillStyle="#ffff66";
		_cntx.lineWidth = 4;
		_cntx.strokeStyle = "#00cc66";
		
		
		
		//kosong
		_cntx.fillRect(0,0,100,100);
		Tile.BLANK = new Image();
		Tile.BLANK.src = _c.toDataURL();
		
		//bulat
		_cntx.fillRect(0,0,100,100);
		
		_cntx.beginPath();
		_cntx.arc(50,50,30,0,2*Math.PI);
		_cntx.stroke();
		
		Tile.NOUGHT = new Image();
		Tile.NOUGHT.src = _c.toDataURL();
		
		//silang
		_cntx.fillRect(0,0,100,100);
		
		_cntx.beginPath();
		_cntx.moveTo(20,20);
		_cntx.lineTo(80,80);
		_cntx.moveTo(80,20);
		_cntx.lineTo(20,80);
		_cntx.stroke();
		
		Tile.CROSS = new Image();
		Tile.CROSS.src = _c.toDataURL();
		
		//tile = Tile.CROSS;
		
		
		tile = Tile.BLANK;
	}
	
	this.hasData = function() {  //click to add Cross or nought
		return tile !== Tile.BLANK;
	}



	this.flip = function(next) {
		tile = next;
		anim = 1;
		}
	
	this.update = function() {
		if (anim > 0) {
			anim -= 0.02;
		}
	}
	
	this.draw = function(cntx) {
		if (anim <= 0){
			cntx.drawImage(tile, x, y);
			return;
		}
		
		var res = 2;
		var t = anim > 0.5 ? Tile.BLANK : tile;
		var p = -Math.abs(2*anim - 1) + 1;   //animation flipping effects

		for (var i = 0; i < 100; i += res){

			var j = 50 - (anim > 0.5 ? 100 - i : i);

			cntx.drawImage(t, i, 0, res, 100,
				x + i - p*i + 50*p,
				y - j*p*0.2,
				res,
				100 + j*p*0.4
			
			);
		}
	}
}

</script>

</head>

<body>
</body>
</html>
